# 基本設計書（課題管理デスクトップアプリケーション ratta）

## BD-DOC 概要

### BD-DOC-001 文書の目的

本書は、課題管理デスクトップアプリケーション ratta（以下、本システム）のプログラム基本設計を示すものである。

本システムに対する機能的要求（FR-xxx）および技術的要求（TR-xxx）は「要求仕様書」に、システム要件（SY-xxx、F-xxx、UI-xxx、D-xxx、T-xxx、NF-xxx）は「要件定義書」にそれぞれ定義されている。本書はそれらをプログラム構造・機能構成・データ構造・表示画面仕様などの観点から具体化し、詳細設計・実装・試験計画の基礎資料とすることを目的とする。

### BD-DOC-002 対象システムの名称・概要

* システム名称
  課題管理デスクトップアプリケーション ratta

* 概要
  ratta は、発注会社(Contractor) と ベンダー(Vendor) が共有する単一プロジェクトの課題情報を管理し、特に課題に紐づくコメント履歴を時系列で見やすく閲覧できるようにするためのデスクトップアプリケーションである。
  本システムは、JSON ファイルによる課題情報の管理と、git 等によるファイル同期運用を前提としつつ、Contractor/Vendor 双方の実務における課題確認・回答・調整作業を支援する。

### BD-DOC-003 本書の対象範囲

本書は次の対象を含む。

* Go 言語 + Wails によるデスクトップアプリケーション ratta 本体
* フロントエンド (Vue 3 + Vuetify 3) の画面構成および主要コンポーネント
* 課題 JSON ファイル・コメント・添付ファイルのデータ構造およびファイル構成
* 設定ファイル、ログファイル、Contractor 専用設定ファイルの配置と扱い
* 基本的なエラー処理および障害対策の方針
* 開発・試験方針（TDD、単体テスト/E2E テストの役割分担）

次の事項は本書の範囲外とし、必要に応じて別文書で扱う。

* git 等のバージョン管理システムの構成・運用手順
* ファイルサーバ構成、バックアップ運用
* セキュリティ設計の詳細（暗号鍵の管理ポリシーなど）

### BD-DOC-004 用語

- Contractor: 発注会社モード
- Vendor: ベンダーモード
- プロジェクト（課題データフォルダ）: 課題 JSON ファイル群を格納するフォルダ（<PROJECT_ROOT>）
- 破損ファイル: JSON として解釈できない、または必須フィールド欠落等で最低限の表示ができない課題 JSON
- スキーマ不整合: JSON としては読めるが、スキーマに一致しない（部分表示は可能）

### BD-DOC-005 参照文書と参照関係

- 要求仕様書: requirements_specification.md（FR-xxx, TR-xxx）
- 要件定義書: requirements_definition.md（SY-xxx, F-xxx, UI-xxx, D-xxx, T-xxx, NF-xxx）
- 詳細設計書: docs/detailed_design.md
- 機械可読定義（別紙）:
  - schemas/issue.schema.json
  - schemas/config.schema.json
  - schemas/contractor.schema.json

参照関係のルール:
- 基本設計は参照を持つ（参照先のファイル名・配置場所・責務を固定する）。
- スキーマ等の確定値は、参照先（schemas/ や docs/）が正とする。
- 基本設計本文に記載した値と参照先が矛盾する場合、要件定義書と参照先の定義を優先し、基本設計を改訂する。

---

## BD-POLICY 設計方針

### BD-POLICY-001 アーキテクチャ方針

- BD-ARCH-001 デスクトップクライアント方式

   * Wails を用いた Windows 向けデスクトップアプリケーションとして実装する。
   * 常設の Web サーバを用いたブラウザ型システムとはせず、ローカルで完結して動作するクライアントとする。

- BD-ARCH-002 フロントエンドとバックエンドの分離

   * バックエンドは Go 言語で実装し、課題管理のビジネスロジック、JSON ファイル I/O、設定・ログ出力等を担当する。
   * フロントエンドは Vue 3 + Vuetify 3 により実装し、ユーザインタフェースと入力バリデーションを担当する。
   * Wails のバインディング機構を通じて、Vue から Go の機能を呼び出す構成とする。

- BD-ARCH-003 データ永続化方針

   * 課題データは「一課題一 JSON ファイル」の構成とする。
   * JSON 更新時は一時ファイルへの書き込み後にリネームするアトミック更新方式とし、書き込み途中の異常終了による破損を防止する。
   * 課題間・コメント間の整合性は JSON スキーマおよびアプリケーション側の入力制御で担保し、複数端末からの同一ファイル更新に伴う競合解消は git 等外部ツールのマージ機能に委ねる。

- BD-ARCH-004 モード切替（Contractor モード / Vendor モード）

   * 起動時に Contractor 専用設定ファイルの有無とパスワード照合により、ratta の動作モードを Contractor モード / Vendor モードのいずれかに決定する。
   * モードに応じて、ステータス変更やカテゴリ操作など一部機能の可否・制約を切り替える。

- BD-ARCH-005 認証・ユーザ管理

   * 本システム内にユーザ管理機能やログイン機能は持たせない。
   * 認証に相当する要素としては、Contractor 専用設定ファイル内に保存されたパスワードの照合のみを用いる。

### BD-POLICY-002 使用技術・言語

- BD-TECH-001 バックエンド

  * 言語: Go
  * フレームワーク: Wails
  * 主な外部ライブラリ

    * 課題 ID 採番: github.com/matoous/go-nanoid

      * 文字セット: `0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ`
      * 桁数: 9
    * コメント ID 採番: github.com/google/uuid（UUID v7）
    * JSON 処理: 標準ライブラリ encoding/json を基本とし、必要に応じて補助ライブラリを利用する。

- BD-TECH-002 フロントエンド

  * Vue 3（Composition API、wails init -n myproject -t vue のテンプレートを前提）
  * Vuetify 3（デフォルトテーマを使用）
  * Markdown レンダリング: markdown-it

- BD-TECH-003 ドキュメント構成

  * docs フォルダ配下に以下の文書を配置する。

    * requirements_specification.md: 要求仕様書（英語）
    * requirements_specification_ja.md: 要求仕様書（日本語）
    * requirements_definition.md: 要件定義書（英語）
    * requirements_definition_ja.md: 要件定義書（日本語）

関連要件: T-001, T-002, T-003

### BD-POLICY-003 責務分界（Go ⇔ Vue）

- BD-DUTY-001 Go 側の責務
  - ファイル I/O（読み込み、検証、更新、添付保存）
  - スキーマ検証
  - ID 採番
  - モード判定（Contractor/Vendor）
  - ログ出力
  - 破損・不整合ファイルの検出とエラー情報の提供

- BD-DUTY-001 Vue 側の責務
  - 表示、入力
  - 画面内バリデーション（必須、文字数、禁止文字など）
  - 画面状態管理
  - エラー表示の統一（エラー詳細ダイアログに集約）

関連要件: SY-003, T-001

### BD-POLICY-004 開発・試験方針

- BD-DEV-001 テスト駆動開発（TDD）の採用

   * Go 側のビジネスロジックは、Go 標準 testing パッケージを用いたテスト駆動開発により実装する。
   * 新機能の追加時は、まずユニットテストを記述し、そのテストが通る実装を行う方針とする。

- BD-DEV-002 単体テスト

   * バックエンド (Go): testing パッケージによるユニットテスト
   * フロントエンド (Vue): Vitest によるコンポーネント単体テスト
   * バックエンドとフロントエンドは原則として別々に単体テストを実施できるように構成する。

- BD-DEV-003 E2E テスト

   * 実際の画面操作と Go バックエンドを含めた E2E テストは、wails dev で起動した開発用サーバに対して Playwright からアクセスする方式で実施する。
   * 代表的なシナリオ例

     * 課題新規登録 → JSON に課題ファイルが生成され、課題一覧画面に反映されること。
     * コメント追加 → JSON にコメントが追加され、課題詳細画面に反映されること。
     * Vendor モードでステータス変更が制約されること。

- BD-DEV-004 最終テスト

   * 要求仕様書に定義された要求 ID（FR-xxx、TR-xxx）を軸に試験項目を作成し、要求と試験のトレーサビリティを確保する。

関連要件: T-001（採用技術）, NF-001（性能前提の補助）, NF-002（運用前提の補助）
---

## BD-CRITERIA 設計条件

### BD-CRITERIA-001 システム前提条件

* 対象 OS: Windows 10 64bit 以降
* 稼働環境: インターネット非接続のオンプレミス環境
* 本システム単体で完結して動作し、クラウドサービスや外部 Web API への依存は持たない。

### BD-CRITERIA-002 運用・データ前提

* 対象プロジェクト: 発注会社(Contractor) と ベンダー(Vendor) の間で取り扱う単一のソフトウェア開発プロジェクト。
* 利用者規模: Contractor/Vendor 合計で 20 名程度を想定。同時利用10名程度を想定。
* 課題件数・コメント件数: それぞれ数百件規模を想定。
* 課題・コメントデータの同期は、別途構築された git 等の外部バージョン管理システムにより行う。ratta 自体は同期機能を持たない。

### BD-CRITERIA-003 非機能要件（抜粋）

* 性能: 数百件規模の課題・コメントを扱った場合でも、実用上問題のない応答時間を確保する（詳細は 7 章）。
* 信頼性: JSON データの破損検出と安全な更新手段を提供し、致命的なデータ消失リスクを低減する。
* 保守性: フロントエンド/バックエンドを明確に分離し、TDD と自動テストを前提にした実装を行うことで変更に強い構成とする。

関連要件: NF-001, D-006, T-006

---

## BD-SYSTEM システム構成

### BD-SYSTEM-001 ハードウェア構成

* クライアント PC

  * CPU: Intel Core i5 同等以上
  * メモリ: 8GB 以上
  * ストレージ: 数 GB 以上の空き容量（課題データ・ログ・一時ファイル等を含む）

課題データの保存先は、下記のいずれかとする。

* クライアント PC のローカルディスク配下のフォルダ
* 社内ファイルサーバ上の共有フォルダ（SMB 等）

関連要件: NF-001

### BD-SYSTEM-002 ソフトウェア構成

* OS: Windows 10 64bit 以降
* ランタイム/フレームワーク

  * Go ランタイム
  * Wails
  * Node.js / npm（フロントエンドビルド用途）
* フロントエンド

  * Vue 3, Vuetify 3, markdown-it
* ログ・設定・Contractor 専用情報

  * ratta.exe と同階層に以下のフォルダを作成し、格納する。

    * auth フォルダ: Contractor 専用設定ファイル (contractor.json)
    * logs フォルダ: ログファイル (ratta.log など)

### BD-SYSTEM-003 プロジェクトフォルダ構成（開発用）

開発プロジェクトは Wails テンプレートに基づき、以下の構成とする。

* docs

  * requirements_definition.md
  * requirements_definition_ja.md
  * requirements_specification.md
  * requirements_specification_ja.md
  * basic_design.md
  * basic_design_ja.md
  * detailed_design.md
  * detailed_design_ja.md

* schemas
  - issue.schema.json
  - config.schema.json
  - contractor.schema.json

* build

  * darwin
  * windows

    * installer
* frontend

  * dist
  * src

    * assets

      * fonts
      * images
    * components
  * wailsjs

    * go

      * main
    * runtime

アプリケーション実行時の課題データフォルダは、上記プロジェクト構成とは別に指定される。

### BD-SYSTEM-004 配布物とディレクトリ構成（実行時）

- 実行ファイル直下
  - ratta.exe
  - auth/
    - contractor.json（存在する場合、Contractor モード候補）
  - logs/
    - ratta.log（ローテーションあり）
    - audit.log（将来実装）
  - config.json（アプリケーション設定）

注記:
- docs/ や schemas/ はアプリケーション（ソース/配布物）側の参照資材であり、<PROJECT_ROOT>（課題データフォルダ）には配置しない。

関連要件: F-002, F-005, T-006, SY-003

---

## BD-DEVREQ プログラムに対する要求分析

詳細な要求事項は以下の文書を参照する。

* 要求仕様書 (FR-xxx, TR-xxx)

  * docs/requirements_specification_ja.md
* 要件定義書 (SY-xxx, F-xxx, UI-xxx, D-xxx, T-xxx, NF-xxx)

  * docs/requirements_definition_ja.md

本書では、6 章の機能構成および 8 章・10 章のデータ仕様を通じて、要求仕様書・要件定義書とのトレーサビリティを確保する。

---

## BD-FUNCTIONS 機能

### BD-FUNCTIONS-001 機能一覧

ratta が提供する主な機能は以下の通りである（括弧内は対応する要件群の例）。

- BD-FB-001 プロジェクト起動・データフォルダ管理機能

   * 起動時にプロジェクト選択ダイアログを表示し、課題データフォルダを確定する。
   * 確定した課題データフォルダパスはアプリケーション設定ファイルに保存し、次回起動時の既定値として用いる。
   * 一起動一プロジェクトとして扱い、起動後のプロジェクト切り替え機能は提供しない。
   * 関連要件: F-001, UI-000, D-001, SY-001, NF-001, NF-002

- BD-FB-002 モード判定・権限制御機能

   * Contractor 専用設定ファイル(auth/contractor.json )の有無とパスワード照合により、Contractor モード / Vendor モードを決定する。
   * モードに応じたステータス変更やカテゴリ操作制限を行う。
   * 関連要件: SY-002, F-002, F-004, F-301

- BD-FB-003 初期化コマンド（Contractor 専用設定ファイル生成）

   * `ratta.exe init contractor` を提供し、auth/contractor.json を生成する。
   * 初期化コマンドはGUIを起動せずに実行できる。
   * 既に設定ファイルが存在する場合は、明示的な上書きオプション（例: `--force`）が指定されない限り上書きせず、エラー終了する。
   
   - 関連要件: F-005, FR-024, TR-007

- BD-FB-004 カテゴリ・課題一覧表示機能

   * カテゴリ単位で課題一覧を表示する。
   * ソート・フィルタ・ページングを提供する。
   * 関連要件: F-101, F-102, F-103, UI-001, UI-002, UI-003, UI-004, NF-001, NF-002

- BD-FB-005 課題登録・編集機能

   * タイトル、説明、回答希望期限、優先度等の課題情報を登録・編集する。
   * 必須項目のバリデーションを行う。
   
   - 関連要件: F-003, F-101, F-102, F-103, UI-005, D-003, D-004

- BD-FB-006 ステータス管理機能

   * ステータス種別と遷移ルールを定義し、Contractor/Vendor モードごとに権限制御を適用し、状態遷移を制御する。
   * 関連要件: F-004, F-101

- BD-FB-007 コメント管理機能

   * 各課題に対するコメントを時系列順に表示し、新規コメントの追加を行う。
   * コメントサイズを UTF-8 バイト数で 100KB 以下に制限する。
   * コメントの編集・削除機能は提供しない。
   * 関連要件: F-201, F-202

- BD-FB-008 添付ファイル管理機能

   * コメント単位で添付ファイルの登録・保存・参照パスの管理を行う。
   * 関連要件: F-203, D-001, D-003

- BD-FB-009 カテゴリ構造管理

   * ディレクトリ構造をカテゴリとみなす。
   * Contractor モードのみ、カテゴリ追加・削除・名称変更を提供する。
   * 関連要件: F-301, D-001

- BD-FB-010 JSON ファイル I/O・検証機能

   * 課題 JSON の読み込み・スキーマ検証・破損検出を行う。
   * 書き込み時は一時ファイルを用いて安全に置換する。
   * 関連要件: D-002, D-003, D-004, D-005, D-006, T-004, T-005

- BD-FB-011 ログ出力・エラー表示機能

   * アプリケーション内部のエラーや重要イベントをログファイルに出力する。
   * ログのローテーションを行う。
   * 関連要件: T-006
   * JSON の読み込み・検証で検出されたエラー情報を専用ダイアログで一覧表示する。
   * 関連要件: T-006（運用性・保守性）


### BD-FUNCTIONS-002 機能間の流れ（概要）

- BD-FLOW-01 初期化コマンド実行（起動引数に `init contractor` が指定された場合）

   * 起動引数を解析し、初期化コマンドの場合は GUI を起動せずに auth/contractor.json の生成処理を実行する。
   * GUI を起動せずに auth/contractor.json の生成処理を実行する。
   * 既存ファイルが存在する場合、`--force` 指定がない限り上書きしない。
   * 生成成功後は終了する。失敗時はエラーを表示して終了する。

   - 関連要件: F-005
- BD-FLOW-02 ratta 起動

   * BD-FB-001 がアプリケーション設定ファイル(config.json)を読み込み、前回の課題データフォルダパスを取得する。
   * BD-FB-001 がプロジェクト選択ダイアログを表示し、課題データフォルダパスを確定する（前回値を既定値として表示）。
   * BD-FB-001 が確定した課題データフォルダパスをアプリケーション設定ファイルへ保存する。
   * BD-FB-002 が Contractor 設定ファイル(auth/contractor.json)の有無を確認し、存在する場合はパスワード照合ダイアログを表示してモードを決定する。

- BD-FLOW-03 課題データ読み込み

   * BD-FB-010 がカテゴリに対応するディレクトリを走査し、課題 JSON ファイルを読み込んで検証する。
   * 読込不能・スキーマ不整合のファイルはエラーリストとして保持する。

- BD-FLOW-04 画面表示

   * BD-FB-004 がカテゴリ一覧および選択カテゴリの課題一覧を表示する。
   * エラーが存在する場合、メニューまたはエラーメニューからエラー詳細ダイアログを開くことができる。

- BD-FLOW-05 課題操作

   * BD-FB-005 が課題の新規登録・編集ダイアログを提供し、BD-FB-006 がステータス変更を制御する。
   * 保存時には BD-FB-010 を介して JSON ファイルに書き戻す。

- BD-FLOW-06 コメント・添付操作

   * BD-FB-007 がコメント追記を行い、DB-FB-007 が添付ファイルの保存と JSON 内の参照情報更新を行う。

- BD-FLOW-07 カテゴリ管理

   * Contractor モード時のみ、BD-FB-009 によりカテゴリ追加・削除を行い、ディレクトリ構造に反映する。

---

## BD-PER 性能

### BD-PERF-001 性能目標

ratta における性能目標は以下の通りとする。

- BD-PT-001 カテゴリ毎課題一覧表示

   * 対象件数: 課題数 500 件、1 ページ 20 件表示
   * 初回表示: 2 秒以内
   * ソート・フィルタ適用: 1 秒以内

- BD-PT-002 課題詳細画面表示

   * 対象コメント数: 200 件を想定
   * 詳細表示: 1 秒以内

- BD-PT-003 コメント登録後の再表示

   * コメント一覧の更新: 1 秒以内

### BD-PERF-002 性能設計の考え方

* 課題・コメント件数は数百件規模に留まるため、起動時にカテゴリ単位で JSON を一括ロードしても実用上許容できる。
* JSON の検証・整形は Go 側で実施し、フロントエンドには表示に必要な情報を渡す。
* 将来的に性能問題が顕著になった場合は、インデックス用キャッシュファイルや部分ロードの導入を詳細設計以降で検討する。

---

## BD-IO 入出力データ仕様（概要）

### BD-IO-001 入力データ

- BD-IN-001 ユーザ入力

  * 課題情報: タイトル、説明、回答希望期限、優先度、ステータス など
  * コメント情報: コメント本文（Markdown）、投稿者名、会社区分 など
  * 添付ファイル: コメントに紐づくファイル

- BD-IN-002 設定ファイル

  * アプリケーション設定ファイル (config.json)
  * Contractor 専用設定ファイル (auth/contractor.json)

- BD-IN-003 既存 JSON ファイル

  * 課題 JSON ファイル群

### BD-IO-002 出力データ

- BD-OUT-001 課題 JSON ファイル

  * 一課題一ファイル
  * 課題情報、コメント情報、添付ファイル情報を含む。

- BD-OUT-002 添付ファイル

  * 各課題・コメントに紐づくバイナリファイル。

- BD-OUT-003 ログファイル

  * logs/ratta.log 形式のログファイル。

### BD-IO-003 主なデータ項目（例）

- BD-DATA-001 課題 JSON（1 件分）

   * issue_id: 課題識別子（nanoid による 9 桁 ID）
   * category: カテゴリ名（ディレクトリ名と対応）
   * title: 課題タイトル
   * description: 課題説明
   * status: ステータス
   * priority: 優先度
   * origin_company: 作成元会社区分（Contractor/Vendor）
   * assignee: 課題担当者名
   * created_at: 作成日時
   * updated_at: 更新日時
   * due_date: 回答希望期限
   * comments: コメント配列
   * attachments: 課題全体に紐づく添付ファイル（必要に応じて）
   * version: スキーマバージョンなど

- BD-DATA-002 コメント要素

   * comment_id: コメント識別子（UUID v7）
   * body: コメント本文（Markdown 文字列）
   * author_name: 投稿者名
   * author_company: 投稿者会社区分（Contractor/Vendor）
   * created_at: コメント投稿日時
   * attachments: 添付ファイル参照情報配列

- BD-DATA-003 添付ファイル参照情報

   * attachment_id
   * file_name
   * relative_path（課題フォルダからの相対パス）
   * mime_type
   * size_bytes など

### BD-IO-004 文字コードとフォーマット

* JSON ファイルの文字コード: UTF-8
* コメントサイズ上限: UTF-8 バイト数で 100KB 以下
* 日時の保存形式: ISO 8601（タイムゾーン付き）を基本とする。
  * 秒までの精度で管理し、ミリ秒以下は取り扱わない（要件定義書 D-004 に準拠）。
* 日時の画面表示形式: 日本語表記（要件定義書 D-004 に準拠）
  * 形式: YYYY年MM月DD日 hh時mm分ss秒（24時間表記）
  * 表示時は、保存値（タイムゾーン付きISO 8601）をパースし、クライアントPCのローカルタイムに変換した上で上記形式に整形する。
  * 例: 2025-12-06T10:30:00+09:00 → 2025年12月06日 10時30分00秒
* JSONファイルでは、インデント 2 スペース、改行は LFとする。
  * JSONスキーマにおいては、x-keyOrder を持たせることで、キー順序を固定する。
---

## BD-SCREEN 表示画面仕様（概要）

### BD-SCREEN-001 画面構成の全体像

ratta は以下の画面で構成される。

- BD-SC-000 プロジェクト選択ダイアログ

   * 起動時に課題データフォルダ（プロジェクト）を選択・作成する
   * 前回の課題データフォルダパスを既定値として表示する

- BD-SC-001 メイン画面

   * カテゴリ一覧（左ペイン）
   * 課題一覧（右ペイン）

- BD-SC-002 課題詳細ダイアログ

   * 課題情報の表示・編集
   * コメント一覧表示・コメント追加
   * 添付ファイル操作

- BD-SC-003 エラー詳細ダイアログ

   * JSON 読み込み・検証エラー等の一覧表示

- BD-SC-004 Contractor 認証ダイアログ

   * Contractor モード起動時のパスワード入力

### BD-SCREEN-002 画面毎の詳細

#### BD-SC-000 プロジェクト選択ダイアログ

* 入力・表示
  * 課題データフォルダパス（設定ファイル(config.json)に保存された前回値を初期表示）
* 操作
  * 開く: 入力されたパスを検証し、問題なければ当該フォルダを課題データフォルダとして確定する
  * 参照: フォルダ選択UIでパスを選択し、入力欄へ反映する
  * 新規作成: 指定パスにプロジェクト用フォルダを作成し、作成したフォルダを課題データフォルダとして確定する
  * キャンセル: アプリケーションを終了する
* エラー
  * フォルダが存在しない、作成できない、アクセスできない場合はエラーメッセージを表示し、確定処理を行わない
* 確定後処理
  * 確定した課題データフォルダパスを設定ファイルへ保存する

#### BD-SC-001 メイン画面

* ヘッダ

  * プロジェクト名またはデータフォルダパス
  * 現在のモード表示（Contractor モード / Vendor モード）

* 左ペイン: カテゴリ一覧

  * ディレクトリ構造をツリーまたはリストで表示
  * Contractor モード時のみカテゴリ追加・削除操作を提供する。

* 右ペイン: 課題一覧

  * 主な表示項目

    * 課題 ID
    * タイトル
    * ステータス
    * 優先度
    * 作成元会社区分（Contractor/Vendor）
    * 更新日時（表示形式は 8.4 に従う）
    * 回答希望期限（表示形式は 8.4 に従う）

  * 操作

    * 行クリックで課題詳細ダイアログを表示
    * 列ヘッダクリックによるソート
    * ステータス・優先度・期限による簡易フィルタ
    * ページング（1 ページ 20 件）

#### BD-SC-002 課題詳細ダイアログ

* 基本情報

  * タイトル（必須）
  * 説明（必須）
  * 回答希望期限（必須）
  * 優先度（必須）
  * ステータス（権限と遷移制約あり）
  * 作成元会社区分（表示のみ）
  * 作成日時・更新日時（表示のみ、表示形式は 8.4 に従う）

* コメント表示

  * 古い順に並べたコメント一覧
  * コメント本文は markdown-it でレンダリングし、改行や箇条書き等を適切に表示する。
  * コメント投稿日時（created_at）は表示形式を 8.4 に従って表示する。

* コメント追加エリア

  * コメント本文入力欄（Markdown テキスト）
  * 投稿者名入力欄
  * 会社区分はモードに応じて決定または入力方式とする（詳細は要件に準拠）。
  * 添付ファイル選択欄

* ステータス変更

  * Contractor/Vendor モードに応じて選択可能なステータスを制御する。
  * ステータス種別(日本語は表示用,英語は内部表現用とする)
    * 新規: Open
    * 対応中: Working
    * 問い合わせ中: Inquiry
    * 保留: Hold
    * 差し戻し: Feedback
    * 完了: Resolved
    * クローズ: Closed
    * 却下: Rejected

  * ステータス遷移図（概要）
    関連要件: F-004

    Closed / Rejected は終了状態であり、以後の遷移は行わない。

    ```mermaid
    stateDiagram-v2
        [*] --> Open
        Open --> InProgress
        state InProgress {
            [*] --> Working
            [*] --> Inquiry
            [*] --> Hold
            Feedback --> Working
            Feedback --> Inquiry
            Feedback --> Hold

            Working --> [*]
            Inquiry --> [*]
            Hold --> [*]

            Working --> Inquiry
            Working --> Hold
            Inquiry --> Working
            Inquiry --> Hold
            Hold --> Working
            Hold --> Inquiry
        }
        InProgress --> Resolved
        Resolved --> Closed
        Resolved --> Feedback

        InProgress --> Rejected
        Closed --> [*]
        Rejected --> [*]
    ```

    補足:
    - Vendor モードで許可されるのは Open / InProgress（Working, Inquiry, Hold, Feedback）/ Resolved の範囲の遷移のみとする。
    - Closed / Rejected への遷移は Contractor モードのみとする。

#### BD-SC-003 エラー詳細ダイアログ

関連要件: D-006, UI-004

- 表示対象
  - JSON パース不能ファイル
  - 必須フィールド欠落、型不整合などのスキーマ不整合
- 表示項目（最低限）
  - ファイル名
  - エラー種別
  - エラーメッセージ
  - ファイルパス表示とコピー操作
- 方針
  - エラー内容の復旧は利用者が手動で実施する（D-006）

#### BD-SC-004 Contractor 認証ダイアログ

関連要件: SY-002, F-002

- 表示条件: 起動時にauth/contractor.json が存在する場合
- 入力: パスワード
- 結果
  - 照合成功: Contractor モードで起動
  - 照合失敗: 起動エラーとしてモーダル表示し、アプリ終了

---

## BD-FILES データファイル仕様

### BD-FILES-001 課題データフォルダ構成

課題データフォルダの配下は、カテゴリおよび課題単位で以下のように構成する。

* <PROJECT_ROOT>/

  * <カテゴリ名>/

    * <issue_id>.json
    * <issue_id>.files/

      * 添付ファイル群(<attachment_id>_<original_file_name>)

  * issue_id/attachment_id は nanoid による 9 桁 ID を用いる。カテゴリ名はディレクトリ名として扱われる。
  * カテゴリ名には、禁止文字（例: \ / : * ? " < > |）や末尾ドット等を設定し、UIの制約条件とします。
  * 添付ファイルの保存名(<attachment_id>_<original_file_name>)では、original_file_nameにWindows 禁止文字が含まれる可能性があるので、サニタイズを行うこと。
  * 添付ファイル名が衝突した際は、suffix 付与で回避すること。
### BD-FILES-002 設定ファイル

- BD-FC-001 アプリケーション設定ファイル

   * 配置場所: ratta.exe と同階層
   * 想定項目

     * 課題データフォルダパス
     * 課題データフォルダパス（前回確定値。起動時の既定値として利用）
     * ログ設定（必要に応じて）
   * フォーマット: JSON （詳細は要件定義書に準拠）
   * 更新ルール
     * 起動時にプロジェクト選択ダイアログで課題データフォルダパスが確定した場合、当該パスで設定ファイルを更新する
   * 例（JSON の場合）
     * {
     *   "project_root_path": "D:/share/projectA",
     *   "log": { "level": "info" }
     * }

- BD-FC-002 Contractor 専用設定ファイル

   * 配置場所: exe と同階層の auth フォルダ配下

     * auth/contractor.json
    * 生成方法: `ratta.exe init contractor` により生成する（既存ファイルがある場合は `--force` 指定がない限り上書きしない）。
   * フォーマット: JSON
   * 想定項目例

     * mode: "contractor"
     * encrypted_password: 暗号化済みパスワード
   * パスワードは暗号化して保存する。暗号方式としては、AES-256-GCM 等の共通鍵暗号と PBKDF2-HMAC-SHA256 による鍵導出を用いる設計とする（詳細値はセキュリティ設計で定義）。

### BD-FILES-003 ログファイル

* 配置場所: exe と同階層の log フォルダ配下

  * logs/ratta.log
    - 世代が変わった場合のログファイル名:logs/ratta.log.1

* ローテーション仕様

  * 1 ファイルあたり最大サイズ: 1MB
  * 最大世代数: 3 世代
  

* ログレベル

  * 通常動作: INFO, ERROR
  * 設定ファイル(config.jsonのlog.levelで制御) : DEBUG, INFO, ERROR

* 記録内容

  * 例外やエラーの概要（スタックトレース含む場合あり）
  * JSON 読み込み・検証時の重大なエラー
  * ユーザ入力値は必要最小限の範囲で記録し、個人情報や機密情報がログに長期間残らないよう配慮する。

* 関連要件: T-006
---

## BD-DATABASE データベース仕様

本システムでは、RDBMS や NoSQL 等の外部データベースは使用せず、JSON ファイルを用いたフラットファイル構成によって課題データを管理する。

そのため、本章における「データベース一覧」「レコード仕様」等は対象外とし、データ構造は 8 章および 10 章の JSON/ファイル仕様で定義する。

---

## BD-SAFETY 障害対策

### BD-SAFETY-001 JSON 書き込み時の対策

* 一時ファイルの使用

  * 更新対象の課題 JSON を書き込む際は、同一ディレクトリ内に一時ファイルを作成し、全データを書き込んだあとでリネームにより本ファイルと入れ換える。
  * 一時ファイル名: <issue_id>.json.tmp.<pid>.<timestamp>
  * 書き込み途中での異常終了により JSON ファイルが中途半端な状態になることを防ぐ。

* fsync の扱い

  * 書き込み性能と実装の簡潔さを優先し、fsync によるディスクへの同期は行わない。
  * ディスクキャッシュ未フラッシュ状態での障害は、運用上のリスク許容範囲内とみなす。

### BD-SAFETY-002 JSON 破損・スキーマ不整合の検出

* 起動時および必要に応じて、全課題 JSON ファイルを読み込んで検証する。
* JSON パースエラーや必須フィールド欠落等のスキーマ不整合を検出し、エラー情報として保持する。
* エラー詳細ダイアログで、ファイル単位にエラー種別とメッセージを表示し、利用者が手動で修正できるようにする。

### BD-SAFETY-003 データ同期競合

* 複数の ratta インスタンスが同一課題 JSON を同時に編集することによる競合は、git 等外部のバージョン管理システムにおけるマージ処理によって解決する前提とする。
* マージ結果として不整合な JSON が生成された場合は、12.2 に示した検証処理によって検出される。
* 上書き事故防止などの処置は、採用しない。

### BD-SAFETY-004 一時ファイル残骸の扱い

* 起動時に .tmp ファイルを検出し、一定条件（一定時間以上経過、サイズ 0 など）で削除、またはエラー一覧に表示して利用者に通知する。
* 削除条件・閾値は詳細設計に記載する。

---

## BD-EVAL 設計内容の評価方針

本基本設計の妥当性を次の観点で評価する。

- BD-EV-001 要求との整合性

   * 要求仕様書・要件定義書に定義された各要求 ID と、6 章の機能ブロック・8 章/10 章のデータ仕様が対応していること。

- BD-EV-002 一貫性・矛盾の有無

   * モード切替、権限制御、データ構造、画面仕様、ログ仕様の間に矛盾がないこと。

- BD-EV-003 実現可能性

   * 想定ハードウェア構成において、7 章の性能目標を達成可能であること。

- BD-EV-004 試験容易性

   * Go/Vue の単体テストおよび Playwright による E2E テストが実施しやすい構造になっていること。
   * FR/TR 要求 ID と試験項目とのトレーサビリティが構築可能であること。

